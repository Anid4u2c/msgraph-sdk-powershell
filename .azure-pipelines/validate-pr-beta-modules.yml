# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

# Validate pull requests to dev branches for Graph workload modules.
name: $(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
pr:
  branches:
    include:
    - dev
  paths:
    include:
      - src/*
      - config/ModulesMapping.jsonc
    exclude:
      - src/Authentication/*
trigger: none

variables:
  MODULE_MAPPING_BETA: '$(System.DefaultWorkingDirectory)/config/ModulesMapping.jsonc'
  BUILD_NUMBER: $[format('{0:yyMMddHHmm}', pipeline.startTime)]

jobs:
- job: MSGraphPSSDKValidation
  displayName: MS Graph PS Service Module Validation
  timeoutInMinutes: 360
  pool:
    vmImage: 'windows-latest'
  
  steps:
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-credscan.CredScan@2
    displayName: 'Run: CredScan'
    inputs:
      toolMajorVersion: V2
      debugMode: false
  
  - task: PowerShell@2
    displayName: 'Register: Dev Feed'
    inputs:
      targetType: inline
      script: |
          $Pat = ConvertTo-SecureString -String '$(PS_DEV_FEED_PAT)' -AsPlainText -Force
          $Cred = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $(PS_DEV_FEED), $Pat
          $Params = @{
              'Name' = '$(PS_DEV_FEED)'
              'InstallationPolicy' = 'Trusted'
              'SourceLocation' = '$(PS_DEV_FEED_URL)'
              'Credential' = $Cred
          }
          Register-PSRepository @Params
      pwsh: true

  - task: NodeTool@0
    displayName: 'Install: Node'
    inputs:
      versionSpec: '13.14.0'
  
  - task: Npm@1
    displayName: 'Install: AutoRest'
    inputs:
      command: 'custom'
      customCommand: 'install -g autorest'
  
  - task: PowerShell@2
    displayName: 'Generate and Build: Service Modules'
    inputs:
      filePath: '$(System.DefaultWorkingDirectory)/tools/GenerateModules.ps1'
      arguments: '-RepositoryName $(PS_DEV_FEED) -ModulePreviewNumber $(BUILD_NUMBER) -Build'
      pwsh: true
  
  - task: PowerShell@2
    displayName: 'Pack: Service Modules'
    inputs:
      targetType: 'inline'
      script: |
        [HashTable] $ModuleMapping = Get-Content $(MODULE_MAPPING_BETA) | ConvertFrom-Json -AsHashTable
        $ModuleMapping.Keys | ForEach-Object -Parallel {
            $ModuleName = $_
            & $(System.DefaultWorkingDirectory)/tools/PackModule.ps1 -Module $ModuleName -ArtifactsLocation $(Build.ArtifactStagingDirectory)
        }
      pwsh: true
  
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: Service Modules'
    inputs:
      pathToPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: drop
  
  - task: YodLabs.O365PostMessage.O365PostMessageBuild.O365PostMessageBuild@0
    displayName: 'Graph Client Tooling pipeline fail notification'
    inputs:
      addressType: serviceEndpoint
      serviceEndpointName: 'microsoftgraph pipeline status'
      title: '$(Build.DefinitionName) failure notification'
      text: 'This pipeline has failed. View the build details for further information. This is a blocking failure. '
    condition: and(failed(), ne(variables['Build.Reason'], 'Manual'))
    enabled: true
